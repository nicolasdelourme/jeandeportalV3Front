import{a6 as e,l as t,a as r}from"./vue-vendor-BHZkLje3.js";import{l as a,b as n}from"./index-BamJDk-5.js";class o extends Error{statusCode;originalError;constructor(e,t,r){super(e),this.name="ShopAPIError",this.statusCode=t,this.originalError=r}}function s(e){return e?e.startsWith("http")?e:`https://jeandeportal.fr/${e}`:""}function i(e,t="EUR"){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:t}).format(e)}function l(e){const t=e.indexOf("_");if(-1===t)return{raw:e,prefix:"",value:e,displayName:e};const r=e.substring(0,t),a=e.substring(t+1),n=a.charAt(0).toUpperCase()+a.slice(1);return{raw:e,prefix:r,value:a,displayName:n}}function c(e,t){const r=e.find(e=>e.startsWith(`${t}_`));return r?l(r):null}function u(e){return e.filter(e=>!e.startsWith("filter_")&&!e.startsWith("reco_")).map(l)}function f(e,t,r){const a=e.tag?e.tag.split(",").map(e=>e.trim()).filter(Boolean):[],n=(e.image_array||[]).filter(e=>e&&e.path).map(e=>`https://jeandeportal.fr/${e.path}`),o=(e.reference_array||[]).map(e=>function(e,t){const r=(e.price_array||[]).map(e=>{const t=e.discountPrice>0&&e.discountPrice<e.price;return{id:String(e.priceId||""),amount:t?(e.discountPrice||0)/100:(e.price||0)/100,htAmount:t?(e.HTDiscount||0)/100:(e.HTPrice||0)/100,vatRate:e.vat||0,currency:(e.currency||"EUR").toUpperCase(),label:void 0,isPromo:t,originalAmount:t?(e.price||0)/100:void 0}}),a=(e.image_array||[]).filter(e=>e&&e.path).map(e=>`https://jeandeportal.fr/${e.path}`),n=a.length>0?a:t;return{id:String(e.referenceId||""),name:e.name||"",description:e.description||"",images:n,prices:r,physical:!0,immaterial:!1,weight:0,width:0,height:0,depth:0}}(e,n));return{id:String(e.itemId),name:e.name||"",subname:e.subname||"",description:e.description||"",technicalReference:e.seoUrl||"",images:n,products:o,collectionId:t,tags:[...a,r],stock:999,visible:!0,available:!0,timestamp:"",priority:0}}function d(e){if(!e)return"";if("undefined"==typeof document)return e;const t=document.createElement("textarea");return t.innerHTML=e,t.value}function m(e){if(!e)return"";if("undefined"==typeof document)return e;const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""}function p(e){return d(e)}const v={CATALOG:"/fetchStore"},h=3e4;const g=new class{abortController=null;async fetchCatalog(){this.abortController&&this.abortController.abort(),this.abortController=new AbortController;try{const e=setTimeout(()=>{this.abortController?.abort()},h),t=await n.get(v.CATALOG,{signal:this.abortController.signal});if(clearTimeout(e),!t||!t.category_array)throw new o("Structure de réponse API invalide: attendu un objet avec category_array");return function(e){try{if(!e||!e.category_array)return a.error("❌ Invalid API response structure. Expected object with category_array"),{references:[]};const r=[];for(const n of e.category_array){const e=String(n.categoryId||"uncategorized"),o=n.name||"";for(const s of n.item_array||[])try{const t=f(s,e,o);r.push(t)}catch(t){a.error(`❌ Error mapping item ${s.itemId}:`,t)}}return{references:r}}catch(t){return a.error("❌ Fatal error in mapAPIResponseToShopCatalog:",t),{references:[]}}}(t)}catch(e){if(e instanceof o)throw e;const t=e;if(t.response)throw new o(`Erreur HTTP: ${t.response.status} ${t.response.statusText}`,t.response.status);if(t.request){if("ECONNABORTED"===t.code||"AbortError"===t.name)throw new o("Requête annulée ou timeout");throw new o("Aucune réponse du serveur")}if(e instanceof Error)throw new o(`Erreur lors de la récupération du catalogue: ${e.message}`,void 0,e);throw new o("Erreur inconnue lors de la récupération du catalogue")}finally{this.abortController=null}}cancelRequest(){this.abortController&&(this.abortController.abort(),this.abortController=null)}},y="jdp_shop_catalog_cache",w=3e5,C=e("shop",()=>{const e=t({references:[]}),n=t(!1),s=t(null),i=t(0),c=t(new Set),u=t(new Set),f=t(""),d=t("newest"),m=r(()=>e.value.references),p=r(()=>{const e=new Map;for(const t of m.value){const r=t.products.flatMap(e=>e.prices.map(e=>e.amount));e.set(t.id,{min:r.length>0?Math.min(...r):1/0,max:r.length>0?Math.max(...r):-1/0})}return e}),v=r(()=>function(e){const t=new Set;return e.forEach(e=>{t.add(e.collectionId)}),Array.from(t).sort()}(m.value)),h=r(()=>function(e){const t=new Set;return e.forEach(e=>{e.tags.forEach(e=>t.add(e))}),Array.from(t).sort()}(m.value)),C=r(()=>{let e=m.value;if(c.value.size>0&&(e=e.filter(e=>c.value.has(e.collectionId))),u.value.size>0&&(e=e.filter(e=>Array.from(u.value).some(t=>e.tags.includes(t)))),f.value.trim()){const t=f.value.toLowerCase().trim();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)||e.technicalReference.toLowerCase().includes(t))}return e}),b=r(()=>{let e=m.value;return c.value.size>0&&(e=e.filter(e=>c.value.has(e.collectionId))),function(e){const t=new Set;return e.forEach(e=>{e.tags.forEach(e=>{e.startsWith("filter_")&&t.add(e)})}),Array.from(t).map(l).sort((e,t)=>e.displayName.localeCompare(t.displayName,"fr"))}(e)}),S=r(()=>{const e=C.value,t=d.value;if("name-asc"===t)return[...e].sort((e,t)=>e.name.localeCompare(t.name,"fr"));if("name-desc"===t)return[...e].sort((e,t)=>t.name.localeCompare(e.name,"fr"));if("newest"===t)return[...e].sort((e,t)=>parseInt(t.id)-parseInt(e.id));if("oldest"===t)return[...e].sort((e,t)=>parseInt(e.id)-parseInt(t.id));if("price-asc"===t||"price-desc"===t){const r=p.value;return"price-asc"===t?[...e].sort((e,t)=>(r.get(e.id)?.min??1/0)-(r.get(t.id)?.min??1/0)):[...e].sort((e,t)=>(r.get(t.id)?.max??-1/0)-(r.get(e.id)?.max??-1/0))}return[...e]}),I=r(()=>{if(0===i.value)return!1;return Date.now()-i.value<w}),E=r(()=>S.value.length),A=r(()=>c.value.size>0||u.value.size>0||""!==f.value.trim()),T=async(t=!1)=>{if(!(!t&&I.value&&e.value.references.length>0)&&(t||!(()=>{try{const t=localStorage.getItem(y);if(!t)return!1;const r=JSON.parse(t),a=Date.now();return r.version&&"2.0"===r.version?a-r.timestamp>w?(localStorage.removeItem(y),!1):(e.value=r.catalog,i.value=r.timestamp,!0):(localStorage.removeItem(y),!1)}catch{return localStorage.removeItem(y),!1}})())){n.value=!0,s.value=null;try{const t=await g.fetchCatalog();e.value=t,i.value=Date.now(),(()=>{try{const t={version:"2.0",catalog:e.value,timestamp:i.value};localStorage.setItem(y,JSON.stringify(t))}catch(t){}})()}catch(r){s.value=r instanceof o?r:new o("Erreur inconnue"),a.error("❌ Failed to fetch shop catalog:",r)}finally{n.value=!1}}},_=()=>{c.value.clear(),u.value.clear(),f.value="",d.value="newest"};return{catalog:e,isLoading:n,error:s,lastFetchTimestamp:i,activeCollectionFilters:c,activeTagFilters:u,searchQuery:f,activeSortOption:d,references:m,availableCollections:v,availableTags:h,availableTagsFiltered:b,filteredReferences:C,sortedReferences:S,isCacheValid:I,resultsCount:E,hasActiveFilters:A,fetchCatalog:T,refresh:async()=>{await T(!0)},clearCache:()=>{e.value={references:[]},i.value=0,localStorage.removeItem(y),_()},toggleCollectionFilter:e=>{c.value.has(e)?c.value.delete(e):c.value.add(e),c.value=new Set(c.value)},toggleTagFilter:e=>{u.value.has(e)?u.value.delete(e):u.value.add(e),u.value=new Set(u.value)},clearCollectionFilters:()=>{c.value.clear(),c.value=new Set},clearTagFilters:()=>{u.value.clear(),u.value=new Set},setSearchQuery:e=>{f.value=e},setSortOption:e=>{d.value=e},resetFilters:_,findReferenceById:e=>m.value.find(t=>t.id===e)}});export{c as a,p as b,u as c,d,i as f,s as g,m as s,C as u};
