import{a6 as e,l as t,a}from"./vue-vendor-BHZkLje3.js";import{b as n,e as r,d as s,g as i,t as o}from"./index-BamJDk-5.js";class l extends Error{code;statusCode;constructor(e,t,a){super(e),this.name="OneClickBasketError",this.code=t,this.statusCode=a}}const c={portefeuillepermanent:"portefeuille",metauxprecieux:"metaux",libertefinanciere:"liberte",bonus:"bonus"},u={P1M:"monthly",P1Y:"yearly"};function d(e){const t=e.oneClickBillingScheme?.[0],a=t?.price??0,n=c[e.oneClick?.technicalTag]||"metaux",r=u[e.regularInterval]||"monthly";return{planId:e.planId,name:e.name,description:e.description,price:a/100,priceInCentimes:a,trialDays:e.trialdays,interval:r,currency:e.currency,theme:n,oneClickId:e.oneClick?.oneClickId,oneClickName:e.oneClick?.name}}function m(e){return{basketCode:e.basket?.basketCode||"",items:(e.basket?.plan_array||[]).map(d)}}const h={FETCH_BASKET:"/fetchOneClickBasket",ADD:"/addOneClick",DELETE:"/deleteOneClick",CHECKOUT:"/oneClickCheckout",INIT_PAYMENT:"/oneClickInitPayment"};const y=new class{async fetchBasket(e){try{const t=await n.post(h.FETCH_BASKET,{basketCode:e});if("error"===t.status)throw new l(t.message||"Panier non trouve","BASKET_NOT_FOUND");return m(t)}catch(t){if(t instanceof l)throw t;const e=r(t),a=s(t);if(404===e)throw new l("Panier non trouve","BASKET_NOT_FOUND",404);throw new l(a?.message||"Erreur lors de la recuperation du panier","NETWORK_ERROR",e)}}async addPlan(e,t=28,a=null){try{const r={planId:e,storeId:t};a&&(r.basketCode=a);const s=await n.post(h.ADD,r);if("error"===s.status)throw new l(s.message||"Erreur lors de l'ajout","PLAN_NOT_FOUND");return m(s)}catch(i){if(i instanceof l)throw i;const e=r(i),t=s(i);throw new l(t?.message||"Erreur lors de l'ajout du plan","NETWORK_ERROR",e)}}async removePlan(e,t){try{const a=await n.post(h.DELETE,{planId:e,basketCode:t});if("error"===a.status)throw new l(a.message||"Erreur lors de la suppression","BASKET_NOT_FOUND");return m(a)}catch(a){if(a instanceof l)throw a;const e=r(a),t=s(a);throw new l(t?.message||"Erreur lors de la suppression","NETWORK_ERROR",e)}}async checkout(e){try{const t=await n.post(h.CHECKOUT,{basketCode:e});if("error"===t.status||!t.stripePublicKey)throw new l(t.message||"Erreur lors du checkout","AUTH_REQUIRED");return{publicKey:t.stripePublicKey}}catch(t){if(t instanceof l)throw t;const e=r(t),a=s(t);if(401===e)throw new l("Authentification requise","AUTH_REQUIRED",401);throw new l(a?.message||"Erreur lors du checkout","NETWORK_ERROR",e)}}async initPayment(e,t,a){try{const r=await n.post(h.INIT_PAYMENT,{basketCode:e,adressId:t,billAdressId:a});if("error"===r.status||!r.client_secret||!r.stripePublicKey)throw new l(r.message||"Erreur lors de l'initialisation du paiement","INIT_FAILED");return{clientSecret:r.client_secret,publicKey:r.stripePublicKey}}catch(i){if(i instanceof l)throw i;const e=r(i),t=s(i);if(401===e)throw new l("Authentification requise","AUTH_REQUIRED",401);if(404===e)throw new l("Panier non trouve","BASKET_NOT_FOUND",404);throw new l(t?.message||"Erreur lors de l'initialisation du paiement","NETWORK_ERROR",e)}}};const k=e("oneClickBasket",()=>{const e=t({basketCode:null,items:[],isLoading:!1,isSynced:!1,error:null});return{basketCode:a(()=>e.value.basketCode),items:a(()=>e.value.items),currentPlan:a(()=>e.value.items[0]||null),isEmpty:a(()=>0===e.value.items.length),hasItems:a(()=>e.value.items.length>0),totalPrice:a(()=>{const t=e.value.items[0];return t?t.price:0}),isLoading:a(()=>e.value.isLoading),error:a(()=>e.value.error),isSynced:a(()=>e.value.isSynced),initialize:async function(){e.value.isSynced=!0},syncWithBackend:async function(){if(e.value.basketCode){e.value.isLoading=!0,e.value.error=null;try{const t=await y.fetchBasket(e.value.basketCode);e.value.basketCode=t.basketCode,e.value.items=t.items,e.value.isSynced=!0}catch(t){throw e.value.error=i(t),t}finally{e.value.isLoading=!1}}else e.value.isSynced=!0},addPlan:async function(t,a=!1){e.value.isLoading=!0,e.value.error=null;try{const a=t,n=await y.addPlan(a,28,null);e.value.basketCode=n.basketCode,e.value.items=n.items,e.value.isSynced=!0,o.success("Abonnement ajoute")}catch(n){throw e.value.error=i(n),o.error(i(n)),n}finally{e.value.isLoading=!1}},removePlan:async function(){const t=e.value.items[0];if(!e.value.basketCode||!t)return;const a=t.planId;e.value.isLoading=!0,e.value.error=null;try{const t=await y.removePlan(a,e.value.basketCode);e.value.items=t.items,e.value.isSynced=!0,o.success("Abonnement retire")}catch(n){throw e.value.error=i(n),o.error(i(n)),n}finally{e.value.isLoading=!1}},clearBasket:function(){e.value={basketCode:null,items:[],isLoading:!1,isSynced:!1,error:null}},resetBasket:function(){e.value={basketCode:null,items:[],isLoading:!1,isSynced:!1,error:null}}}});export{y as o,k as u};
