import{a6 as e,l as t,a as r}from"./vue-vendor-BHZkLje3.js";import{l as n,b as a}from"./index-BamJDk-5.js";const o={portefeuillepermanent:"portefeuille",metauxprecieux:"metaux",libertefinanciere:"liberte",bonus:"bonus"},l={"abonnement essentiel":"essentiel","abonnement standard":"standard","abonnement premium":"premium"},i={P1M:"monthly",P1Y:"yearly"},s={essentiel:1,standard:5,premium:10},c={essentiel:1,standard:2,premium:3};class u extends Error{statusCode;originalError;constructor(e,t,r){super(e),this.name="SubscriptionCatalogAPIError",this.statusCode=t,this.originalError=r}}function m(e){const t=o[e.technicalTag];if(!t)return n.warn(`Unknown technicalTag: ${e.technicalTag}`),null;const r=function(e){const t=e.toLowerCase().trim();for(const[r,n]of Object.entries(l))if(t.includes(r))return n;return t.includes("premium")?"premium":t.includes("standard")?"standard":"essentiel"}(e.description),a=e.plan_array?.[0];if(!a)return n.warn(`No plan found for product: ${e.name}`),null;const c=(a.billingScheme_array||[]).map(e=>({id:String(e.id),interval:i[e.regularInterval]||"monthly",price:e.price/100,priceInCentimes:e.price}));return{id:String(e.id),planId:Number(a.id),oneClickId:String(a.oneClickId),theme:t,tier:r,name:e.name,trialDays:a.trialDays||0,pricing:c,stars:s[r]}}const p={CATALOG:"/fetchOneClickCatalog"},d=3e4;const h=new class{abortController=null;async fetchCatalog(){this.abortController&&this.abortController.abort(),this.abortController=new AbortController;try{const e=setTimeout(()=>{this.abortController?.abort()},d),t=await a.get(p.CATALOG,{signal:this.abortController.signal});if(clearTimeout(e),!t||!t.oneClick_array)throw new u("Structure de reponse API invalide: attendu un objet avec oneClick_array");return{plans:function(e){const t=[],r=new Map,n=new Map;["metaux","portefeuille","liberte","bonus"].forEach(e=>r.set(e,[])),["essentiel","standard","premium"].forEach(e=>n.set(e,[]));for(const o of e.oneClick_array||[]){const e=m(o);e&&(t.push(e),r.get(e.theme)?.push(e),n.get(e.tier)?.push(e))}const a=(e,t)=>c[e.tier]-c[t.tier];return t.sort(a),r.forEach(e=>e.sort(a)),{plans:t,byTheme:r,byTier:n,lastUpdated:Date.now()}}(t).plans}}catch(e){if(e instanceof u)throw e;const t=e;if(t.response)throw new u(`Erreur HTTP: ${t.response.status} ${t.response.statusText}`,t.response.status);if(t.request){if("ECONNABORTED"===t.code||"AbortError"===t.name)throw new u("Requete annulee ou timeout");throw new u("Aucune reponse du serveur")}if(e instanceof Error)throw new u(`Erreur lors de la recuperation du catalogue: ${e.message}`,void 0,e);throw new u("Erreur inconnue lors de la recuperation du catalogue")}finally{this.abortController=null}}cancelRequest(){this.abortController&&(this.abortController.abort(),this.abortController=null)}},f="jdp_subscription_catalog_cache",g=3e5,v=e("subscriptionCatalog",()=>{const e=t([]),a=t(!1),o=t(null),l=t(0),i=r(()=>{if(0===l.value)return!1;return Date.now()-l.value<g}),c=r(()=>e.value.length>0),m=t=>e.value.filter(e=>e.theme===t),p=e=>{const t=m(e);return 0===t.length?[]:t.map(e=>{const t=function(e){const t=e.pricing.find(e=>"monthly"===e.interval);return t?.price??null}(e),r=e.pricing.find(e=>"yearly"===e.interval);return{id:e.tier,planId:e.planId,name:(n=e.tier,n.charAt(0).toUpperCase()+n.slice(1)),priceMonthly:t??0,priceYearly:r?.price,recommended:"standard"===e.tier,isPremium:"premium"===e.tier,stars:e.stars,oneClickId:e.oneClickId,trialDays:e.trialDays};var n})},d=async(t=!1)=>{if(!(!t&&i.value&&e.value.length>0)&&(t||!(()=>{try{const t=localStorage.getItem(f);if(!t)return!1;const r=JSON.parse(t),n=Date.now();return r.version&&"1.0"===r.version?n-r.timestamp>g?(localStorage.removeItem(f),!1):(e.value=r.plans,l.value=r.timestamp,!0):(localStorage.removeItem(f),!1)}catch{return localStorage.removeItem(f),!1}})())){a.value=!0,o.value=null;try{const t=await h.fetchCatalog();e.value=t.plans,l.value=Date.now(),(()=>{try{const t={version:"1.0",plans:e.value,timestamp:l.value};localStorage.setItem(f,JSON.stringify(t))}catch(t){}})()}catch(r){o.value=r instanceof u?r:new u("Erreur inconnue"),n.error("❌ Failed to fetch subscription catalog:",r)}finally{a.value=!1}}};return{plans:e,isLoading:a,error:o,lastFetchTimestamp:l,isCacheValid:i,hasPlans:c,getPlansByTheme:m,getPlansByTier:t=>e.value.filter(e=>e.tier===t),getPlan:(t,r)=>e.value.find(e=>e.theme===t&&e.tier===r),getPlansForTheme:p,getPricingPlans:()=>{const e=p("metaux");return e.length>0?e:[]},fetchCatalog:d,refresh:async()=>{await d(!0)},clearCache:()=>{e.value=[],l.value=0,localStorage.removeItem(f)},formatPrice:e=>function(e){return e.toFixed(2).replace(".",",")+"€"}(e),getStarsForTier:e=>s[e]}});export{v as u};
