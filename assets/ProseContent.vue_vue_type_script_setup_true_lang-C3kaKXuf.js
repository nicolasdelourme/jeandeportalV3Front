import{_ as e,a as t,b as r,c as n,d as a,e as s}from"./TableHeader.vue_vue_type_script_setup_true_lang-mEEMBt15.js";import{l,A as o,a as i,w as c,m as u,y as d,Q as h,H as p,G as g,L as m,R as f,u as y,N as v,K as w,U as b,I as x,W as _,V as k,S as L,a9 as H,F as q,Z as C,a5 as E}from"./vue-vendor-BHZkLje3.js";import{l as S}from"./index-BamJDk-5.js";import{_ as T}from"./Skeleton.vue_vue_type_script_setup_true_lang-C_McNZtf.js";import{_ as A,a as M}from"./index-j_h2RxZR.js";import{_ as j}from"./AlertTitle.vue_vue_type_script_setup_true_lang-3SqVJcCT.js";import{b as P,F,d as R,a as I}from"./DefaultLayout.vue_vue_type_script_setup_true_lang-Br6uEOr3.js";import{n as D}from"./news.service-C63P7LKh.js";const O=["https://code.highcharts.com/highcharts.js","https://code.highcharts.com/highcharts-more.js","https://code.highcharts.com/modules/accessibility.js","https://code.highcharts.com/modules/annotations.js","https://code.highcharts.com/modules/exporting.js","https://code.highcharts.com/modules/export-data.js","https://imipie.ovh/project/pie/js/highcharts-pie-payload.js"],$={isLoaded:!1,isLoading:!1,error:null};let z=null;function N(e){return new Promise((t,r)=>{if(document.querySelector(`script[src="${e}"]`))return void t();const n=document.createElement("script");n.src=e,n.async=!1,n.onload=()=>t(),n.onerror=()=>r(new Error(`Échec du chargement: ${e}`)),document.head.appendChild(n)})}function J(){const e=l($.isLoaded),t=l($.isLoading),r=l($.error);return{isLoaded:e,isLoading:t,error:r,loadHighcharts:async function(){if($.isLoaded)e.value=!0;else{if(z)return await z,e.value=$.isLoaded,void(r.value=$.error);$.isLoading=!0,$.error=null,t.value=!0,r.value=null,z=async function(){for(const e of O)await N(e);if(!window.Highcharts)throw new Error("Highcharts non disponible après le chargement des scripts");if(!window.HighchartsPayloadClient)throw new Error("HighchartsPayloadClient non disponible après le chargement des scripts")}().then(()=>{$.isLoaded=!0,$.isLoading=!1,e.value=!0,t.value=!1}).catch(e=>{throw $.error=e instanceof Error?e:new Error(String(e)),$.isLoading=!1,r.value=$.error,t.value=!1,z=null,e}),await z}}}}class V extends Error{statusCode;originalCause;constructor(e,t,r){super(e),this.name="ImiPieAPIError",this.statusCode=t,this.originalCause=r}}const G=3e4,B=3e5;const K=new class{cache=new Map;pendingRequests=new Map;isCacheValid(e){return Date.now()-e.timestamp<B}async fetchChart(e){const t=e,r=this.cache.get(t);if(r&&this.isCacheValid(r))return r.data;const n=this.pendingRequests.get(t);if(n)return n;const a=this.fetchFromAPI(e).then(e=>(this.cache.set(t,{data:e,timestamp:Date.now()}),e)).finally(()=>{this.pendingRequests.delete(t)});return this.pendingRequests.set(t,a),a}async fetchFromAPI(e){const t=new AbortController,r=setTimeout(()=>t.abort(),G);try{const n=await fetch(e,{method:"GET",signal:t.signal,headers:{Accept:"application/json"}});if(clearTimeout(r),!n.ok)throw new V(`Erreur HTTP: ${n.status} ${n.statusText}`,n.status);return await n.json()}catch(n){if(clearTimeout(r),n instanceof V)throw n;if(n instanceof Error){if("AbortError"===n.name)throw new V("Requête annulée ou timeout");throw new V(`Erreur lors de la récupération du graphique: ${n.message}`,void 0,n)}throw new V("Erreur inconnue lors de la récupération du graphique")}}clearCache(){this.cache.clear()}invalidateCache(e){this.cache.delete(e)}},Q={class:"absolute flex flex-col items-center gap-2 text-muted-foreground"},U=["id"],W=I(o({__name:"HighchartsChart",props:{config:{}},setup(e){const t=e,r=i(()=>({triangleExclamation:P.fas?.["triangle-exclamation"],undo:P.fas?.undo,chartLine:P.fas?.["chart-line"]})),n=l(`highcharts-${Math.random().toString(36).substring(2,11)}`),a=l(null);let s=null,o=null;const H=l(null),q=l(null),C=l(!1),{isLoaded:E,isLoading:I,error:D,loadHighcharts:O}=J(),$=i(()=>t.config.height);async function z(){C.value=!0,q.value=null;try{H.value=await K.fetchChart(t.config.url)}catch(e){e instanceof V||e instanceof Error?q.value=e.message:q.value="Erreur lors du chargement du graphique",S.error("[HighchartsChart] Fetch error:",e)}finally{C.value=!1}}function N(){if(!H.value||!E.value)return;if(document.getElementById(n.value))try{const e=JSON.parse(JSON.stringify(H.value)),t=window.Highcharts,r=window.HighchartsPayloadClient;if(r)r.render(n.value,e),s=t?.charts?.find(e=>e?.renderTo?.id===n.value)||null;else{if(!t||!e.chart)throw new Error("Highcharts ou HighchartsPayloadClient non disponible");s=t.chart(n.value,e.chart)}}catch(e){S.error("[HighchartsChart] Render error:",e),q.value="Erreur lors du rendu du graphique"}else S.error("[HighchartsChart] Container not found:",n.value)}async function G(){q.value=null,await B()}async function B(){try{await O(),await z(),N()}catch(e){S.error("[HighchartsChart] Init error:",e)}}return c([H,E],([e,t])=>{e&&t&&requestAnimationFrame(()=>{N()})}),c(()=>t.config,()=>{z()},{deep:!0}),u(()=>{B(),a.value&&(o=new ResizeObserver(()=>{s&&s.reflow()}),o.observe(a.value))}),d(()=>{o&&(o.disconnect(),o=null),s&&(s.destroy(),s=null)}),(e,t)=>(p(),h("div",{ref_key:"wrapperRef",ref:a,class:"highcharts-chart-wrapper my-6"},[y(I)||C.value?(p(),h("div",{key:0,class:"flex flex-col items-center justify-center bg-muted/30 rounded-lg border border-border relative",style:v({height:$.value||"400px"})},[w(y(T),{class:"w-full h-full rounded-lg"}),b("div",Q,[r.value.chartLine?(p(),g(y(F),{key:0,icon:r.value.chartLine,class:"size-8 animate-pulse"},null,8,["icon"])):m("",!0),t[0]||(t[0]=b("span",{class:"text-sm"},"Chargement du graphique...",-1))])],4)):q.value||y(D)?(p(),g(y(A),{key:1,variant:"destructive",class:"my-4"},{default:x(()=>[r.value.triangleExclamation?(p(),g(y(F),{key:0,icon:r.value.triangleExclamation,class:"size-4"},null,8,["icon"])):m("",!0),w(y(j),null,{default:x(()=>[...t[1]||(t[1]=[_("Erreur de chargement",-1)])]),_:1}),w(y(M),{class:"flex flex-col gap-3"},{default:x(()=>[b("p",null,k(q.value||y(D)?.message),1),w(y(R),{variant:"outline",size:"sm",class:"w-fit",onClick:G},{default:x(()=>[r.value.undo?(p(),g(y(F),{key:0,icon:r.value.undo,class:"size-4 mr-2"},null,8,["icon"])):m("",!0),t[2]||(t[2]=_(" Réessayer ",-1))]),_:1})]),_:1})]),_:1})):m("",!0),f(b("div",{id:n.value,class:"highcharts-container rounded-lg px-0",style:v($.value?{height:$.value}:void 0)},null,12,U),[[L,!(y(I)||C.value||q.value||y(D))]])],512))}}),[["__scopeId","data-v-d46ae45d"]]),Z={key:0,class:"flex items-center gap-3 py-3 my-6 border-y border-neutral-200 not-prose animate-pulse"},X={key:1,class:"flex items-center gap-3 py-3 my-6 border-y border-neutral-200 not-prose"},Y=o({__name:"ArticleTeaser",props:{slug:{}},setup(e){const t=e,r=l(null),n=l(!0);return u(async()=>{try{const e=await D.fetchNewsItem(t.slug);r.value=e.title}catch{r.value=null}finally{n.value=!1}}),(t,a)=>{const s=H("RouterLink");return n.value?(p(),h("div",Z,[...a[0]||(a[0]=[b("span",{class:"h-4 w-24 bg-neutral-200 rounded"},null,-1),b("span",{class:"h-4 w-48 bg-neutral-200 rounded"},null,-1)])])):r.value?(p(),h("div",X,[a[1]||(a[1]=b("span",{class:"text-sm font-semibold text-muted-foreground uppercase tracking-wide whitespace-nowrap"},"A lire aussi",-1)),w(s,{to:`/actualites/${e.slug}`,class:"text-sm font-medium text-primary hover:underline truncate"},{default:x(()=>[_(k(r.value),1)]),_:1},8,["to"])])):m("",!0)}}}),ee={class:"prose-tiptap"},te=["innerHTML"],re={key:0,class:"flex items-center gap-2.5 mb-2"},ne={class:"font-heading font-bold text-lg my-0!"},ae=["innerHTML"],se={key:5,class:"flex items-start gap-2.5 border-l-4 border-neutral-300 rounded-lg p-4 lg:p-6 italic text-neutral-600 my-5"},le=["innerHTML"],oe=o({__name:"ProseContent",props:{html:{}},setup(l){const o=l;function c(e){const t=(new DOMParser).parseFromString(e,"text/html").querySelector("table");if(!t)return{headers:[],rows:[]};const r=[],n=[],a=t.querySelector("thead");if(a){a.querySelectorAll("th, td").forEach(e=>{r.push(e.innerHTML)})}return(t.querySelector("tbody")||t).querySelectorAll("tr").forEach((e,t)=>{if(!a&&0===t&&e.querySelector("th")){return void e.querySelectorAll("th, td").forEach(e=>{r.push(e.innerHTML)})}const s=[];e.querySelectorAll("td, th").forEach(e=>{s.push(e.innerHTML)}),s.length>0&&n.push(s)}),{headers:r,rows:n}}function u(e){const t=(new DOMParser).parseFromString(e,"text/html").querySelector("div[data-imipie-chart]");if(!t)return null;const r=t.getAttribute("data-url");return r?{url:r,height:t.getAttribute("data-height")||void 0,title:t.getAttribute("data-title")||void 0}:null}function d(e){const t=(new DOMParser).parseFromString(e,"text/html").querySelector("div[data-article-teaser]");if(!t)return null;const r=t.getAttribute("data-slug");return r?{slug:r}:null}function f(e){const t=(new DOMParser).parseFromString(e,"text/html").querySelector("div[data-callout]");return t?{style:t.getAttribute("data-style")||"info",icon:t.getAttribute("data-icon")||null,title:t.getAttribute("data-title")||null,content:t.innerHTML}:null}const v={alerte:{icon:"triangle-exclamation",iconClass:"text-primary",classes:"border-l-4 border-l-primary bg-primary/10 rounded-lg p-4 lg:p-6 my-5"},info:{icon:"circle-info",iconClass:"text-primary",classes:"border-2 border-primary rounded-lg p-4 lg:p-6 my-5"},success:{icon:"circle-check",iconClass:"text-emerald-600",classes:"border-l-4 border-l-emerald-500 bg-emerald-50 rounded-lg p-4 lg:p-6 my-5"},danger:{icon:"shield-halved",iconClass:"text-red-600",classes:"border-l-4 border-l-red-500 bg-red-50 rounded-lg p-4 lg:p-6 my-5"}};function _(e){const t=e.icon??v[e.style]?.icon??"circle-info";return P.fas?.[t]}function L(e){return v[e]?.iconClass??v.info.iconClass}function H(e){const t=(new DOMParser).parseFromString(e,"text/html").querySelector("blockquote");return{content:t?.innerHTML??""}}const S=P.fas?.["quote-left"],T=i(()=>{if(!o.html)return[];const e=[],t=/(<table[\s\S]*?<\/table>)|(<div[^>]*data-imipie-chart[^>]*>(?:<\/div>)?)|(<div[^>]*data-article-teaser[^>]*>(?:<\/div>)?)|(<div[^>]*data-callout[^>]*>[\s\S]*?<\/div>)|(<blockquote[\s\S]*?<\/blockquote>)/gi;let r,n=0;for(;null!==(r=t.exec(o.html));){if(r.index>n){const t=o.html.slice(n,r.index).trim();t&&e.push({type:"html",content:t})}const t=r[0];if(r[1])e.push({type:"table",content:c(t)});else if(r[2]){const r=u(t);r&&e.push({type:"chart",content:r})}else if(r[3]){const r=d(t);r&&e.push({type:"teaser",content:r})}else if(r[4]){const r=f(t);r&&e.push({type:"callout",content:r})}else r[5]&&e.push({type:"blockquote",content:H(t)});n=r.index+r[0].length}if(n<o.html.length){const t=o.html.slice(n).trim();t&&e.push({type:"html",content:t})}return e});return(l,o)=>(p(),h("div",ee,[(p(!0),h(q,null,C(T.value,(l,o)=>{return p(),h(q,{key:o},["html"===l.type?(p(),h("div",{key:0,innerHTML:l.content},null,8,te)):"table"===l.type?(p(),g(y(e),{key:1,class:"my-6"},{default:x(()=>[l.content.headers.length?(p(),g(y(t),{key:0},{default:x(()=>[w(y(r),null,{default:x(()=>[(p(!0),h(q,null,C(l.content.headers,(e,t)=>(p(),g(y(n),{key:t,innerHTML:e},null,8,["innerHTML"]))),128))]),_:2},1024)]),_:2},1024)):m("",!0),w(y(a),null,{default:x(()=>[(p(!0),h(q,null,C(l.content.rows,(e,t)=>(p(),g(y(r),{key:t},{default:x(()=>[(p(!0),h(q,null,C(e,(e,t)=>(p(),g(y(s),{key:t,class:E({"font-medium":0===t}),innerHTML:e},null,8,["class","innerHTML"]))),128))]),_:2},1024))),128))]),_:2},1024)]),_:2},1024)):"chart"===l.type?(p(),g(y(W),{key:2,config:l.content},null,8,["config"])):"teaser"===l.type?(p(),g(Y,{key:3,slug:l.content.slug},null,8,["slug"])):"callout"===l.type?(p(),h("div",{key:4,class:E((i=l.content.style,v[i]?.classes??v.info.classes))},[l.content.title?(p(),h("div",re,[_(l.content)?(p(),g(y(F),{key:0,icon:_(l.content),class:E(["w-5 h-5 shrink-0",L(l.content.style)])},null,8,["icon","class"])):m("",!0),b("h4",ne,k(l.content.title),1)])):m("",!0),b("div",{class:E(l.content.title?"":"flex items-start gap-2.5")},[!l.content.title&&_(l.content)?(p(),g(y(F),{key:0,icon:_(l.content),class:E(["w-5 h-5 mt-[0.34em] shrink-0",L(l.content.style)])},null,8,["icon","class"])):m("",!0),b("div",{class:"text-lg leading-relaxed [&>p]:mb-2 [&>p:last-child]:mb-0",innerHTML:l.content.content},null,8,ae)],2)],2)):"blockquote"===l.type?(p(),h("blockquote",se,[y(S)?(p(),g(y(F),{key:0,icon:y(S),class:"text-neutral-300 text-lg opacity-60"},null,8,["icon"])):m("",!0),b("div",{class:"[&>p]:mb-0",innerHTML:l.content.content},null,8,le)])):m("",!0)],64);var i}),128))]))}});export{oe as _};
